<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DEI CMT</title>

    <link rel="stylesheet" href="/styles.css" />
    <link rel="shortcut icon" href="/dei_logo.png" type="image/x-icon" />
  </head>
  <body>
    <%- include('../partials/dashboard/header') %>

    <div class="container">
  

    
        <h4>Manage Submissions</h4>
<form
          action="/publish/review-results"
          method="POST"
        >
               <input type="hidden" name="conference_id" value="<%= confdata.conference_id %>" />
             <% 
  // Get current date in IST
  const now = new Date();
  const istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
  const istTime = new Date(now.getTime() + istOffset);
  const currentDate = istTime.toISOString().split("T")[0];
  
  // Simple string comparison (works for YYYY-MM-DD format)
  const isNotificationDateReached = currentDate >= confdata.acceptance_notification;
%>



<% if (isNotificationDateReached) { %>
  <div class="alert alert-success mb-3">
    <i class="bi bi-check-circle"></i> Review results can now be published!
  </div>
  <input type="submit" class="btn btn-outline-danger" value="Publish Review Results" />
<% } else { %>
 
  <button type="button" class="btn btn-outline-secondary" disabled 
          title="Available from <%= confdata.acceptance_notification %>">
    <i class="bi bi-lock"></i> Publish Review Results (Available from <%= confdata.acceptance_notification %>)
  </button>
<% } %>
</form>
        <hr>

        <!-- Search and Filter Section -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="form-group">
              <label for="searchInput">Search Submissions</label>
              <input 
                type="text" 
                id="searchInput" 
                class="form-control" 
                placeholder="Search by title, author, or paper code..."
              >
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="trackFilter">Filter by Track</label>
              <select id="trackFilter" class="form-control">
                <option value="">All Tracks</option>
                <% if (tracks && tracks.length > 0) { %>
                  <% tracks.forEach(function(track) { %>
                    <option value="<%= track.track_name %>"><%= track.track_name %></option>
                  <% }); %>
                <% } %>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label for="statusFilter">Filter by Status</label>
              <select id="statusFilter" class="form-control">
                <option value="">All Statuses</option>
                <% if (uniqueStatuses && uniqueStatuses.length > 0) { %>
                  <% uniqueStatuses.forEach(function(status) { %>
                    <option value="<%= status %>"><%= status %></option>
                  <% }); %>
                <% } %>
              </select>
            </div>
          </div>
        </div>

        <!-- Results Count -->
        <div class="row mb-3">
          <div class="col-12">
            <span id="resultsCount" class="badge badge-info">
              Showing <span id="visibleCount"><%= submissions ? submissions.length : 0 %></span> 
              of <span id="totalCount"><%= submissions ? submissions.length : 0 %></span> submissions
            </span>
            <button id="clearFilters" class="btn btn-sm btn-outline-secondary ms-2" style="display: none;">
              Clear Filters
            </button>
          </div>
        </div>

        <hr>
        
        <div id="submissionsContainer">
          <% if (submissions && submissions.length > 0) { %>
            <div class="table-responsive">
              <style>
                /* Constrain columns and force wrapping so content stays in the right column */
                .cs-table td { vertical-align: top; padding: 12px; }
                .cs-title { max-width: 220px; white-space: normal; word-wrap: break-word; word-break: break-word; }
                .cs-track { max-width: 160px; white-space: normal; word-wrap: break-word; }
                .cs-primary { max-width: 220px; white-space: normal; word-wrap: break-word; }
                .cs-coauthors { max-width: 240px; white-space: normal; word-wrap: break-word; }
                .cs-status { max-width: 100px; white-space: normal; }
                .cs-reviewer { max-width: 180px; white-space: normal; word-wrap: break-word; }
                .cs-score { max-width: 160px; white-space: normal; }
                .cs-actions { white-space: nowrap; }
              </style>
           <div class="table-responsive">
  <table class="table table-bordered align-middle text-wrap" style="width:100%;">
    <thead class="table-light text-center">
      <tr>
        <th style="min-width:200px;">Title</th>
        <th style="min-width:180px;">Track</th>
        <th style="min-width:200px;">Primary Author</th>
        <th style="min-width:200px;">Co-Authors</th>
        <th style="min-width:120px;">Status</th>
        <th style="min-width:200px;">Reviewer</th>
        <th style="min-width:180px;">Score / Remarks</th>
        <th style="min-width:150px;">View / Actions</th>
      </tr>
    </thead>

    <tbody>
      <% submissions.forEach(function(submission) { %>
        <tr>
          <!-- Title -->
          <td><%= submission.title %></td>

          <!-- Track -->
          <td><%= submission.track_name || '—' %></td>

          <!-- Primary Author -->
          <td><%= submission.primary_author_formatted %></td>

          <!-- Co-Authors -->
          <td><%= submission.co_authors_formatted || '—' %></td>

          <!-- Status -->
          <td class="text-center">
            <span class="badge 
              <%= submission.submission_status === 'Accepted' ? 'bg-success' : 
                  submission.submission_status === 'Rejected' ? 'bg-danger' : 
                  submission.submission_status === 'Reviewed' ? 'bg-warning text-dark' : 
                  'bg-secondary' %>">
              <%= submission.submission_status %>
            </span>
          </td>

          <!-- Reviewer -->
          <td>
            <% if (submission.reviewer_name || submission.reviewer) { %>
              <%= submission.reviewer_name ? submission.reviewer_name + ' (' + (submission.reviewer || '') + ')' : (submission.reviewer || '') %>
            <% } else { %>
              <em class="text-muted">—</em>
            <% } %>
          </td>

          <!-- Score / Remarks -->
          <td>
              <% if (!['Submitted for Review', 'Reviewed'].includes(submission.submission_status)) { %>
              <% if (submission.mean_score) { %>
                <div><strong>Score:</strong> <%= submission.mean_score %></div>
              <% } %>
              <% if (submission.remarks) { %>
                <div><strong>Remarks:</strong> <%= submission.remarks %></div>
              <% } %>
              <% if (!submission.mean_score && !submission.remarks) { %>
                <em class="text-muted">No reviewer details</em>
              <% } %>
            <% } else { %>
              <em class="text-muted"><center><i class="bi bi-eye-slash-fill"></i></center></em>
            <% } %>
          </td>

          <!-- View / Actions -->
          <td class="text-center">
            <a href="<%= submission.file_url %>" target="_blank" class="btn btn-outline-primary btn-sm mb-1">
              <i class="bi bi-eye-fill"></i> View
            </a>
            <form 
              action="/chair/dashboard/delete-submission/<%= submission.submission_id %>?conference_id=<%= confdata.conference_id %>" 
              method="POST" 
              style="display:inline-block;" 
              onsubmit="return confirm('Delete this submission? This action cannot be undone.');">
              <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>

            </div>
          <% } else { %>
            <div id="noSubmissionsMessage">
              <h6 class="text-muted"><i class="bi bi-emoji-frown-fill"></i> No Submissions found.</h6>
            </div>
          <% } %>
        </div>

        <div id="noResultsMessage" style="display: none;">
          <h6 class="text-muted"><i class="bi bi-search"></i> No submissions match your search criteria.</h6>
        </div>
      </div>
    

    <script src="/script.js"></script>
    
    <!-- Search and Filter JavaScript -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const trackFilter = document.getElementById('trackFilter');
        const statusFilter = document.getElementById('statusFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const submissionsContainer = document.getElementById('submissionsContainer');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const visibleCountSpan = document.getElementById('visibleCount');
        const totalCountSpan = document.getElementById('totalCount');
        const noSubmissionsMessage = document.getElementById('noSubmissionsMessage');

        const submissionItems = document.querySelectorAll('.submission-item');
        const totalSubmissions = submissionItems.length;

        function filterSubmissions() {
          const searchTerm = searchInput.value.toLowerCase().trim();
          const selectedTrack = trackFilter.value;
          const selectedStatus = statusFilter.value;
          
          let visibleCount = 0;
          let hasActiveFilters = searchTerm || selectedTrack || selectedStatus;

          submissionItems.forEach(item => {
            const title = item.getAttribute('data-title');
            const track = item.getAttribute('data-track');
            const status = item.getAttribute('data-status');
            const author = item.getAttribute('data-author');
            const coauthors = item.getAttribute('data-coauthors');
            const papercode = item.getAttribute('data-papercode');

            // Check search term
            const matchesSearch = !searchTerm || 
              title.includes(searchTerm) || 
              author.includes(searchTerm) || 
              coauthors.includes(searchTerm) || 
              papercode.includes(searchTerm);

            // Check track filter
            const matchesTrack = !selectedTrack || track === selectedTrack;

            // Check status filter
            const matchesStatus = !selectedStatus || status === selectedStatus;

            // Show/hide item based on all criteria
            const isVisible = matchesSearch && matchesTrack && matchesStatus;
            item.style.display = isVisible ? 'block' : 'none';

            if (isVisible) visibleCount++;
          });

          // Update results count
          visibleCountSpan.textContent = visibleCount;
          totalCountSpan.textContent = totalSubmissions;

          // Show/hide no results message
          if (visibleCount === 0 && totalSubmissions > 0) {
            noResultsMessage.style.display = 'block';
            if (noSubmissionsMessage) noSubmissionsMessage.style.display = 'none';
          } else {
            noResultsMessage.style.display = 'none';
            if (noSubmissionsMessage && totalSubmissions === 0) {
              noSubmissionsMessage.style.display = 'block';
            }
          }

          // Show/hide clear filters button
          clearFiltersBtn.style.display = hasActiveFilters ? 'inline-block' : 'none';
        }

        function clearAllFilters() {
          searchInput.value = '';
          trackFilter.value = '';
          statusFilter.value = '';
          filterSubmissions();
        }

        // Event listeners
        searchInput.addEventListener('input', filterSubmissions);
        trackFilter.addEventListener('change', filterSubmissions);
        statusFilter.addEventListener('change', filterSubmissions);
        clearFiltersBtn.addEventListener('click', clearAllFilters);

        // Initialize
        filterSubmissions();
      });
    </script>

  <%- include('../partials/footer') %>
  </body>
</html>
