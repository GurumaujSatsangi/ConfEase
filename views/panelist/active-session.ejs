<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DEI CMT</title>
    <link rel="shortcut icon" href="/dei_logo.png" type="image/x-icon">
    <link rel="stylesheet" href="/styles.css" />
    
  </head>
  <body>
    <%- include('../partials/dashboard/header') %>
     

    
      

      <div class="container">
        <h4>Panelist's Dashboard</h4>
        <h6><%= trackinfo.track_name %></h6>
        <% if (session_end_iso) { %>
          <div class="alert alert-info" id="sessionTimerContainer">
            Session ends in: <span id="sessionTimer">--:--:--</span>
          </div>
        <% } %>
        
        <hr>
    
<% if (session && session.length > 0) { %> <%
        session.forEach(function(session) { %>
        <table class="table">

          <tr>
            <td><b>Paper Title</b></td>
            <td><b>Mean Score awarded by Reviewer</b></td>
            <td><b>View Paper</b></td>
            <td><b>Panelist Score</b></td>
          </tr>
          <tr>
               <form action="/mark-presentation-as-complete" method="POST">
    <input type="hidden" name="paper_id" value="<%= session.submission_id %>">
        <input type="hidden" name="track_id" value="<%= trackinfo.track_id %>">


            <td><%= session.title %></td>
            <td>
              <% if (session.mean_score !== null && session.mean_score !== undefined) { %>
                <span class="badge bg-primary"><%= session.mean_score %></span>
              <% } else { %>
                <span class="badge bg-secondary">Not Reviewed</span>
              <% } %>
            </td>
            <td><a href="<%= session.file_url%>" target="_blank"><i class="bi bi-cloud-arrow-down-fill"></i></a></td>
            
            <% if (session.presentation_status === 'Completed' || session.submission_status === 'Presentation Completed') { %>
            <td>
              <span class="badge bg-success">
                <% if (session.panelist_score !== null && session.panelist_score !== undefined) { %>
                  <%= session.panelist_score %> <i class="bi bi-check-circle-fill"></i>
                <% } else { %>
                  Completed <i class="bi bi-check-circle-fill"></i>
                <% } %>
              </span>
            </td>
            <td></td>
            <% } else { %>
            <td>
              <input type="number" class="form-control" max="5" step="0.1" id="panelist_score" name="panelist_score" required>
            </td>
            <td>
              <input type="submit" class="btn btn-outline-primary" id="savePanelistBtn" value="Save">
            </td>
            <% } %>
          </form> 

          </tr>
        </table>
        
        <% }); %> <% } else { %>
        <h2>No Submissions Found</h2>
        <% } %>
    </main>
<% if (message) { %>
  <script>
    Swal.fire({
      title: 'Alert',
      text: '<%= message %>',
      icon: 'info',
      confirmButtonText: 'OK'
    });
    if (window.location.search.includes('message=')) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  </script>
  <% } %>

      </div>
    <script src="/script.js"></script>
    <% if (session_end_iso) { %>
    <script>
      (function(){
        const endIso = '<%= session_end_iso %>';
        const endTime = new Date(endIso).getTime();
        const timerEl = document.getElementById('sessionTimer');
        const saveBtn = document.getElementById('savePanelistBtn');
        const scoreInputs = document.querySelectorAll('input[name="panelist_score"]');

        function formatRemaining(ms) {
          if (ms < 0) return '00:00:00';
          const s = Math.floor(ms / 1000);
          const hh = String(Math.floor(s / 3600)).padStart(2,'0');
          const mm = String(Math.floor((s % 3600) / 60)).padStart(2,'0');
          const ss = String(s % 60).padStart(2,'0');
          return `${hh}:${mm}:${ss}`;
        }

        let warned1 = false; // 1 minute
        let warned30 = false; // 30 seconds

        function tick(){
          const now = Date.now();
          const remaining = endTime - now;
          if (timerEl) timerEl.textContent = formatRemaining(remaining);

          if (!warned1 && remaining <= 60*1000 && remaining > 30*1000) {
            warned1 = true;
            alert('Session will end in 1 minute. Please wrap up your scoring.');
          }
          if (!warned30 && remaining <= 30*1000 && remaining > 0) {
            warned30 = true;
            alert('Session will end in 30 seconds. Please finalize your input.');
          }

          if (remaining <= 0) {
            // Disable score inputs and save button
            scoreInputs.forEach(i => i.disabled = true);
            if (saveBtn) saveBtn.disabled = true;
            if (timerEl) timerEl.textContent = '00:00:00';
            // Optional: show an info message
            const container = document.getElementById('sessionTimerContainer');
            if (container) container.className = 'alert alert-danger';
            clearInterval(intervalId);
          }
        }

        tick();
        const intervalId = setInterval(tick, 1000);
      })();
    </script>
    <% } %>
    <%- include('../partials/footer')%>
  </body>
</html>
